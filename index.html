<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D4iL9 Wrk0u7 v3</title>

  <meta name="theme-color" content="#0b0c10" id="metaThemeColor" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon_192.png" />
  <link rel="apple-touch-icon" href="./icon_192.png" />

  <style>
    :root {
      --bg: #0b0c10;
      --bgGradient: radial-gradient(1200px 600px at 20% -10%, #1f2937 0%, transparent 50%), #0b0c10;
      --card: rgba(20,22,28,0.85);
      --text: #e8e8e8;
      --muted: #9ca3af;
      --border: rgba(38,42,54,0.8);
      --btnBg: #2a2f3d;
      --btnText: #e8e8e8;
      --btnBorder: #3a4154;
      --accent: #32cd32;
      --accentSoft: rgba(50,205,50,0.18);
      --warningSoft: rgba(128,128,128,0.18);
      --statBg: rgba(16,19,26,0.6);
      --shadowMd: 0 8px 32px rgba(0,0,0,.35);
      --blur: blur(12px);
      --radius: 18px;
    }

    body.theme-light {
      --bg: #f8fafc;
      --bgGradient: radial-gradient(1200px 600px at 20% -10%, #dbeafe 0%, transparent 50%), #f8fafc;
      --card: rgba(255,255,255,0.82);
      --text: #1e293b;
      --muted: #64748b;
      --border: rgba(226,232,240,.9);
      --btnBg: #f1f5f9;
      --btnText: #1e293b;
      --btnBorder: #e2e8f0;
      --accent: #22c55e;
      --accentSoft: rgba(34,197,94,0.14);
      --warningSoft: rgba(107,114,128,0.12);
      --statBg: rgba(248,250,252,0.75);
      --shadowMd: 0 8px 28px rgba(148,163,184,0.18);
      --blur: blur(8px);
    }

    body.theme-energy {
      --bg: #0f172a;
      --bgGradient: radial-gradient(1200px 600px at 20% -10%, #312e81 0%, transparent 50%), #0f172a;
      --card: rgba(15,23,42,0.86);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: rgba(99,102,241,0.35);
      --btnBg: #1e293b;
      --btnText: #e2e8f0;
      --btnBorder: #334155;
      --accent: #a78bfa;
      --accentSoft: rgba(167,139,250,0.2);
      --warningSoft: rgba(148,163,184,0.15);
      --statBg: rgba(15,23,42,0.66);
      --shadowMd: 0 10px 34px rgba(0,0,0,0.42);
      --blur: blur(10px);
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      color: var(--text);
      background: var(--bgGradient);
      min-height: 100dvh;
    }

    .wrap { max-width: 760px; margin: 0 auto; padding: 16px; }

    .card {
      background: var(--card);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      margin: 14px 0;
      box-shadow: var(--shadowMd);
    }

    h1 { margin: 0 0 6px; font-size: 22px; }
    .sub { color: var(--muted); font-size: 13px; }
    .small { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }

    .topActions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    button, .toggle {
      background: var(--btnBg);
      color: var(--btnText);
      border: 1px solid var(--btnBorder);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    button:focus-visible, .row:focus-visible, .toggle:focus-within {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat { background: var(--statBg); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .big { font-size: 24px; color: var(--accent); font-weight: 700; }

    .focusCard { border-color: color-mix(in srgb, var(--accent) 42%, var(--border)); }
    .focusTop { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
    .focusName { font-size: 18px; font-weight: 800; margin-top: 6px; }
    .focusHint { font-size: 13px; color: var(--muted); margin-top: 8px; }

    .listControls { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      border-top: 1px solid var(--border);
      padding: 14px 10px;
      margin: 0 -10px;
      border-radius: 12px;
      touch-action: pan-y;
      user-select: none;
      transition: opacity .2s ease, transform .2s ease, background-color .2s ease;
    }
    .row:first-child { border-top: 0; }
    .row--dimmed { opacity: .45; }
    .row--active { background: var(--accentSoft); border-color: transparent; }

    input[type="checkbox"] { width: 24px; height: 24px; margin-top: 2px; flex-shrink: 0; }
    .label { flex: 1; min-width: 0; }
    .title { font-weight: 700; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .howto { font-size: 14px; margin-top: 6px; line-height: 1.45; }

    .rowActions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .ghost { background: transparent; }

    .timerWrap, .counterWrap {
      margin-top: 10px; padding: 10px;
      border: 1px solid var(--border); border-radius: 12px; background: var(--statBg);
    }
    .timerDisplay, .counterBig { font-weight: 800; color: var(--accent); font-variant-numeric: tabular-nums; }
    .timerBtns, .counterBtns { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: var(--card); border: 1px solid var(--btnBorder); border-radius: 14px;
      padding: 10px 14px; opacity: 0; pointer-events: none; transition: .2s ease;
    }
    .toast.show { opacity: 1; bottom: 24px; }

    .visually-hidden {
      position: absolute !important; width: 1px; height: 1px; margin: -1px;
      overflow: hidden; clip: rect(0 0 0 0); border: 0; padding: 0;
    }
  </style>
</head>
<body class="theme-dark">
  <div class="wrap">
    <div class="card">
      <h1>D4iL9 Wrk0u7 v3</h1>
      <div class="sub" id="todayLine"></div>
      <div class="small" style="margin-top:10px;">Swipe right to complete · left to reset</div>

      <div class="topActions">
        <button id="startRoutineBtn">Start Routine</button>
        <button id="stopRoutineBtn" style="display:none;">Stop Routine</button>
        <label class="toggle"><input type="checkbox" id="quietToggle" /> Quiet</label>
        <button id="themeToggleBtn">Theme</button>
        <button id="monthlyAvgBtn">Summary</button>
      </div>
    </div>

    <div class="card focusCard" id="focusCard">
      <div class="focusTop">
        <div class="small">Current Step</div>
        <button id="jumpToStepBtn" class="ghost">Jump to row</button>
      </div>
      <div class="focusName" id="focusName">Not started</div>
      <div class="focusHint" id="focusHint">Press “Start Routine” to begin.</div>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat">
          <div class="small">Completion</div>
          <div class="big" id="todayPct">0%</div>
          <div class="small" id="todayCount">0 of 0</div>
        </div>
        <div class="stat">
          <div class="small">Streak</div>
          <div class="big" id="streak">0 days</div>
          <div class="small" id="lastDone">Never</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="listControls">
        <div class="small">Checklist</div>
        <label class="toggle"><input type="checkbox" id="compactDoneToggle" /> Compact completed</label>
      </div>
      <div id="checklist"></div>
    </div>

    <div class="card" style="display:flex; gap:10px; flex-wrap:wrap;">
      <button id="resetTodayBtn">Reset Today</button>
      <button id="markAllBtn">Mark All Done</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(() => {}))
    }

    const routine = [
      { id: "twist", name: "Seated Spinal Twist", detail: "40 seconds total", howto: "Sit upright. Rotate gently. At 20s switch sides.", timers: [{ label: "Twist Timer", seconds: 40, autoCheck: true }] },
      { id: "doorway_pec", name: "Doorway Chest Stretch", detail: "60 seconds", howto: "Forearms on doorway; step forward gently.", demoMp4: "ChestOpenerStretch.mp4", timers: [{ label: "Chest Stretch Timer", seconds: 60, autoCheck: true }] },
      { id: "wall_pushups", name: "Wall Push Ups", detail: "Goal 10 reps", howto: "Hands at chest height, lean in and push out.", demoMp4: "WallPushUps.mp4", repCounter: { goal: 10 } },
      { id: "plank", name: "Plank", detail: "60 seconds", howto: "Straight line, brace core, neutral neck.", timers: [{ label: "Plank Timer", seconds: 60, autoCheck: true, halfwayBuzzAt: 30 }] }
    ];

    const pad2 = (n) => String(n).padStart(2, "0");
    const keyForDate = (d) => `${d.getFullYear()}_${pad2(d.getMonth()+1)}_${pad2(d.getDate())}`;
    const todayKey = () => keyForDate(new Date());
    const storeKey = "microRoutine_v16";

    const loadState = () => {
      try { return JSON.parse(localStorage.getItem(storeKey)) || { days: {}, settings: {} }; }
      catch { return { days: {}, settings: {} }; }
    };
    const saveState = (s) => localStorage.setItem(storeKey, JSON.stringify(s));

    const state = loadState();
    const tKey = todayKey();
    if (!state.days[tKey]) state.days[tKey] = { checks: {}, completedAll: false, counts: {}, events: {}, summary: {} };
    if (!state.settings.theme) state.settings.theme = "dark";
    if (typeof state.settings.quietMode !== "boolean") state.settings.quietMode = false;
    if (typeof state.settings.compactDone !== "boolean") state.settings.compactDone = false;

    const elChecklist = document.getElementById("checklist");
    const elTodayLine = document.getElementById("todayLine");
    const elTodayPct = document.getElementById("todayPct");
    const elTodayCount = document.getElementById("todayCount");
    const elStreak = document.getElementById("streak");
    const elLastDone = document.getElementById("lastDone");
    const elToast = document.getElementById("toast");
    const elThemeToggle = document.getElementById("themeToggleBtn");
    const elQuiet = document.getElementById("quietToggle");
    const elCompactDone = document.getElementById("compactDoneToggle");
    const elFocusName = document.getElementById("focusName");
    const elFocusHint = document.getElementById("focusHint");

    let runnerActive = false;
    let runnerIndex = 0;
    let activeItemId = null;

    const itemElements = {};
    const checkboxElements = {};
    const timerControllers = {};

    function toast(msg) {
      elToast.textContent = msg;
      elToast.classList.add("show");
      setTimeout(() => elToast.classList.remove("show"), 2200);
    }

    function fmtDateLong(key) {
      const [y,m,d] = key.split("_").map(Number);
      return new Date(y,m-1,d).toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
    }

    function applyTheme() {
      const cls = state.settings.theme === "light" ? "theme-light" : state.settings.theme === "energy" ? "theme-energy" : "theme-dark";
      document.body.classList.remove("theme-dark","theme-light","theme-energy");
      document.body.classList.add(cls);
      document.getElementById("metaThemeColor").setAttribute("content", cls === "theme-light" ? "#f8fafc" : cls === "theme-energy" ? "#0f172a" : "#0b0c10");
    }

    function rotateTheme() {
      const seq = ["dark", "light", "energy"];
      const idx = seq.indexOf(state.settings.theme);
      state.settings.theme = seq[(idx + 1) % seq.length];
      saveState(state); applyTheme();
      toast(`Theme: ${state.settings.theme}`);
    }

    function setChecked(itemId, checked) {
      state.days[tKey].checks[itemId] = !!checked;
      if (!state.days[tKey].events) state.days[tKey].events = {};
      if (checked) state.days[tKey].events[itemId] = Date.now();
      else delete state.days[tKey].events[itemId];
      if (checkboxElements[itemId]) checkboxElements[itemId].checked = !!checked;
      updateRowVisual(itemId);
      updateCompletion();
      saveState(state);
    }

    function updateRowVisual(itemId) {
      const row = itemElements[itemId];
      if (!row) return;
      const checked = !!state.days[tKey].checks[itemId];
      if (state.settings.compactDone && checked) {
        row.querySelector(".howto")?.classList.add("visually-hidden");
        row.querySelector(".meta")?.classList.add("visually-hidden");
      } else {
        row.querySelector(".howto")?.classList.remove("visually-hidden");
        row.querySelector(".meta")?.classList.remove("visually-hidden");
      }

      row.classList.toggle("row--active", itemId === activeItemId);
      row.classList.toggle("row--dimmed", runnerActive && itemId !== activeItemId);
    }

    function updateFocusCard() {
      if (!runnerActive || runnerIndex >= routine.length) {
        activeItemId = null;
        elFocusName.textContent = "Not started";
        elFocusHint.textContent = "Press “Start Routine” to begin.";
        routine.forEach(r => updateRowVisual(r.id));
        return;
      }
      const item = routine[runnerIndex];
      activeItemId = item.id;
      elFocusName.textContent = item.name;
      elFocusHint.textContent = item.howto;
      routine.forEach(r => updateRowVisual(r.id));
    }

    function computeStreak() {
      const keys = Object.keys(state.days).sort();
      const fullDays = keys.filter(k => state.days[k]?.completedAll);
      if (!fullDays.length) return { streak: 0, lastFullKey: null };
      const set = new Set(fullDays);
      let streak = 0;
      const [y,m,d] = tKey.split("_").map(Number);
      const date = new Date(y,m-1,d);
      while (set.has(keyForDate(date))) { streak += 1; date.setDate(date.getDate()-1); }
      return { streak, lastFullKey: fullDays[fullDays.length-1] };
    }

    function updateCompletion() {
      const checks = state.days[tKey].checks;
      const done = routine.reduce((a,r) => a + (checks[r.id] ? 1 : 0), 0);
      const total = routine.length;
      const pct = Math.round((done / total) * 100);

      elTodayPct.textContent = `${pct}%`;
      elTodayCount.textContent = `${done} of ${total}`;
      state.days[tKey].completedAll = done === total;
      state.days[tKey].summary = { done, total, pct, updatedAt: Date.now() };

      const streak = computeStreak();
      elStreak.textContent = `${streak.streak} day${streak.streak === 1 ? "" : "s"}`;
      elLastDone.textContent = streak.lastFullKey ? fmtDateLong(streak.lastFullKey) : "Never";
    }

    function buildTimerBlock(item, cb) {
      if (!item.timers?.length) return null;
      const outer = document.createElement("div");

      item.timers.forEach((t, i) => {
        const wrap = document.createElement("div");
        wrap.className = "timerWrap";
        const title = document.createElement("div");
        title.textContent = t.label;
        const display = document.createElement("div");
        display.className = "timerDisplay";
        display.textContent = `${t.seconds}`;

        const btns = document.createElement("div");
        btns.className = "timerBtns";
        const startBtn = document.createElement("button");
        startBtn.textContent = "Start";
        const pauseBtn = document.createElement("button");
        pauseBtn.textContent = "Pause";
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset";

        let remaining = t.seconds, interval = null, halfwayBuzzed = false;
        const beep = () => {
          if (state.settings.quietMode) return;
          try {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            const c = new Ctx(), o = c.createOscillator(), g = c.createGain();
            o.type = "sine"; o.frequency.value = 540;
            o.connect(g); g.connect(c.destination);
            g.gain.value = 0.0001; o.start();
            const n = c.currentTime;
            g.gain.exponentialRampToValueAtTime(0.15, n + 0.02);
            g.gain.exponentialRampToValueAtTime(0.0001, n + 0.2);
            o.stop(n + 0.22); setTimeout(() => c.close(), 250);
          } catch {}
        };

        const render = () => display.textContent = remaining <= 0 ? "Done" : String(remaining);
        const stop = () => { if (interval) clearInterval(interval); interval = null; };
        const tick = () => {
          remaining = Math.max(0, remaining - 1);
          if (!halfwayBuzzed && t.halfwayBuzzAt && remaining === t.halfwayBuzzAt && navigator.vibrate) {
            halfwayBuzzed = true; navigator.vibrate([60,60,60]);
          }
          render();
          if (remaining <= 0) {
            stop();
            if (navigator.vibrate) navigator.vibrate([140,80,140]);
            beep();
            if (t.autoCheck) setChecked(item.id, true, cb);
          }
        };

        startBtn.onclick = () => { if (remaining <= 0) remaining = t.seconds; stop(); interval = setInterval(tick, 1000); render(); };
        pauseBtn.onclick = stop;
        resetBtn.onclick = () => { stop(); remaining = t.seconds; halfwayBuzzed = false; render(); };

        btns.append(startBtn, pauseBtn, resetBtn);
        wrap.append(title, display, btns);
        outer.appendChild(wrap);

        if (!timerControllers[item.id]) timerControllers[item.id] = {};
        timerControllers[item.id][i] = { start: () => startBtn.click(), pause: () => pauseBtn.click(), reset: () => resetBtn.click() };
      });

      return outer;
    }

    function buildRepBlock(item, cb) {
      if (!item.repCounter?.goal) return null;
      const goal = item.repCounter.goal;
      const wrap = document.createElement("div");
      wrap.className = "counterWrap";
      const big = document.createElement("div");
      big.className = "counterBig";

      const btns = document.createElement("div");
      btns.className = "counterBtns";
      const minus = document.createElement("button"); minus.textContent = "-1";
      const plus = document.createElement("button"); plus.textContent = "+1";
      const done = document.createElement("button"); done.textContent = `Set ${goal}`;
      const reset = document.createElement("button"); reset.textContent = "Reset";

      const getCount = () => state.days[tKey].counts?.[item.id] || 0;
      const setCount = (n) => {
        if (!state.days[tKey].counts) state.days[tKey].counts = {};
        state.days[tKey].counts[item.id] = Math.max(0, Math.floor(n));
        const c = getCount();
        big.textContent = `${c} of ${goal}`;
        if (c >= goal) setChecked(item.id, true, cb);
        saveState(state);
      };

      minus.onclick = () => setCount(getCount() - 1);
      plus.onclick = () => setCount(getCount() + 1);
      done.onclick = () => setCount(goal);
      reset.onclick = () => setCount(0);

      setCount(getCount());
      btns.append(minus, plus, done, reset);
      wrap.append(big, btns);
      return wrap;
    }

    function initChecklist() {
      elChecklist.innerHTML = "";
      routine.forEach((item, idx) => {
        const row = document.createElement("div");
        row.className = "row";
        row.tabIndex = 0;
        row.id = `item_${item.id}`;

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!state.days[tKey].checks[item.id];
        cb.setAttribute("aria-label", `Mark ${item.name} complete`);
        cb.addEventListener("change", () => setChecked(item.id, cb.checked));

        const label = document.createElement("div");
        label.className = "label";
        const title = document.createElement("div");
        title.className = "title";
        title.textContent = `${idx + 1}. ${item.name}`;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = item.detail;
        const howto = document.createElement("div");
        howto.className = "howto";
        howto.textContent = item.howto;

        const actions = document.createElement("div");
        actions.className = "rowActions";
        const doneBtn = document.createElement("button");
        doneBtn.textContent = "Done";
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset";
        doneBtn.onclick = () => setChecked(item.id, true);
        resetBtn.onclick = () => setChecked(item.id, false);
        actions.append(doneBtn, resetBtn);

        label.append(title, meta, howto, actions);

        const tBlock = buildTimerBlock(item, cb);
        if (tBlock) label.appendChild(tBlock);

        const rBlock = buildRepBlock(item, cb);
        if (rBlock) label.appendChild(rBlock);

        // swipe
        let startX = 0, currentX = 0, dragging = false;
        row.addEventListener("touchstart", (e) => { startX = e.touches[0].clientX; dragging = true; row.style.transition = "none"; }, { passive: true });
        row.addEventListener("touchmove", (e) => {
          if (!dragging) return;
          currentX = e.touches[0].clientX - startX;
          row.style.transform = `translateX(${currentX}px)`;
          row.style.backgroundColor = currentX > 50 ? "var(--accentSoft)" : currentX < -50 ? "var(--warningSoft)" : "";
        }, { passive: true });
        row.addEventListener("touchend", () => {
          dragging = false;
          row.style.transition = "transform .2s ease, background-color .2s ease";
          row.style.transform = "translateX(0)";
          row.style.backgroundColor = "";
          if (currentX > 100) setChecked(item.id, true);
          else if (currentX < -100) setChecked(item.id, false);
          currentX = 0;
        });

        row.addEventListener("keydown", (e) => {
          if (e.key.toLowerCase() === "d") setChecked(item.id, true);
          if (e.key.toLowerCase() === "r") setChecked(item.id, false);
        });

        row.append(cb, label);
        elChecklist.appendChild(row);

        itemElements[item.id] = row;
        checkboxElements[item.id] = cb;
      });
    }

    function updateChecklistUI() {
      routine.forEach((r) => updateRowVisual(r.id));
      updateFocusCard();
      updateCompletion();
    }

    function runnerAdvance() {
      while (runnerIndex < routine.length && state.days[tKey].checks[routine[runnerIndex].id]) runnerIndex += 1;
      if (runnerIndex >= routine.length) {
        runnerActive = false;
        document.getElementById("startRoutineBtn").style.display = "inline-block";
        document.getElementById("stopRoutineBtn").style.display = "none";
        toast("Routine finished ✅");
      }
      updateChecklistUI();
      if (runnerActive) {
        const item = routine[runnerIndex];
        itemElements[item.id]?.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    document.getElementById("startRoutineBtn").onclick = () => {
      runnerActive = true;
      runnerIndex = 0;
      document.getElementById("startRoutineBtn").style.display = "none";
      document.getElementById("stopRoutineBtn").style.display = "inline-block";
      runnerAdvance();
    };

    document.getElementById("stopRoutineBtn").onclick = () => {
      runnerActive = false;
      document.getElementById("startRoutineBtn").style.display = "inline-block";
      document.getElementById("stopRoutineBtn").style.display = "none";
      updateChecklistUI();
    };

    document.getElementById("jumpToStepBtn").onclick = () => {
      if (!activeItemId) return;
      itemElements[activeItemId]?.scrollIntoView({ behavior: "smooth", block: "center" });
    };

    document.getElementById("markAllBtn").onclick = () => {
      routine.forEach((r) => state.days[tKey].checks[r.id] = true);
      saveState(state); updateChecklistUI(); toast("All done");
    };

    document.getElementById("resetTodayBtn").onclick = () => {
      state.days[tKey] = { checks: {}, completedAll: false, counts: {}, events: {}, summary: {} };
      saveState(state); initChecklist(); updateChecklistUI(); toast("Today reset");
    };

    document.getElementById("monthlyAvgBtn").onclick = () => {
      const keys = Object.keys(state.days);
      const threshold = Date.now() - 30*24*60*60*1000;
      let total = 0, count = 0;
      keys.forEach((k) => {
        const [y,m,d] = k.split("_").map(Number);
        const ts = new Date(y,m-1,d).getTime();
        if (ts > threshold) { total += state.days[k]?.summary?.pct || 0; count++; }
      });
      toast(`30-day average: ${count ? Math.round(total/count) : 0}%`);
    };

    elThemeToggle.onclick = rotateTheme;
    elQuiet.checked = state.settings.quietMode;
    elQuiet.onchange = () => { state.settings.quietMode = !!elQuiet.checked; saveState(state); };

    elCompactDone.checked = state.settings.compactDone;
    elCompactDone.onchange = () => {
      state.settings.compactDone = !!elCompactDone.checked;
      saveState(state);
      updateChecklistUI();
    };

    document.addEventListener("change", (e) => {
      if (e.target?.matches('input[type="checkbox"]') && runnerActive) {
        const curr = routine[runnerIndex];
        if (curr && state.days[tKey].checks[curr.id]) runnerAdvance();
      }
    });

    // lightweight pruning to keep localStorage efficient
    function pruneHistory(days, keepDays = 120) {
      const cutoff = Date.now() - keepDays*24*60*60*1000;
      Object.keys(days).forEach((k) => {
        const [y,m,d] = k.split("_").map(Number);
        if (new Date(y,m-1,d).getTime() < cutoff) {
          const summary = days[k]?.summary || {};
          days[k] = { summary, completedAll: !!days[k]?.completedAll, checks: {}, counts: {}, events: {} };
        }
      });
    }

    pruneHistory(state.days);
    saveState(state);

    elTodayLine.textContent = `Today: ${fmtDateLong(tKey)}`;
    applyTheme();
    initChecklist();
    updateChecklistUI();
  </script>
</body>
</html>
